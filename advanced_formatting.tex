% vim: ts=4 sts=4 sw=4 tw=80
\chapter{高级格式化}
\label{chap:advanced_formatting}
\marginpar{121}

很多时候, 最简单的工作就是把文本或代码修改成更易阅读的形式. 在这一章, 我们将会
介绍一些简单的方法, 用于对文本进行格式化 --- 无论是普通文本还是代码.

这一章主要分为三个部分:
\begin{itemize}
    \item 文本格式化
    \item 代码格式化
    \item 使用外部格式化工具
\end{itemize}

学完这一章后, 用户应该可以清楚地知道当要对文本进行格式化时, 什么情况下应该用
Vim, 什么情况下不应该用 Vim.

\section{格式化文本}
\label{sec:formatting_text}

在编辑普通文本时, 虽然大多数人更喜欢使用图形化字处理软件, 比如 Microsoft Word
或 OpenOffice, 但是许多纯文本编辑器, 比如 Vim, 也可以把事情做得很好. 在下面的
一节里, 我们将会介绍如何利用 Vim 强大的功能来格式化普通文本.
\marginpar{122}

\subsection{文本分段}
\label{subsec:putting_text_into_paragraphs}

这一节所介绍的知识可能是整本书中最简单的, 但是对于格式化普通文本来说, 却可能是
最有用的. 假设用户正在编写一段文本, 并且在编写的过程中丝毫没有注意到行的变化与
文本的格式. 最终, 用户可能会写出一行非常长的文本, 此时他才注意到应该对文本重新
进行格式化, 摆在他面前的有两个选择:
\begin{itemize}
    \item 遍历文本, 并在适当的地方断行
    \item 用某个命令对整段文本进行格式化
\end{itemize}
很显然, 后者是最好的选择, 并且格式化后的结果也可以和其他结果保持一致. 所使用的
命令是:
\begin{vimcode}
gqap
\end{vimcode}
上面的命令其时是两个命令的组合:
\begin{itemize}
    \item \texttt{gq}: Format everything the next movement moves
        over\footnote{TODO}
    \item \texttt{ap}: ``A paragraph'' moves over the current
        paragraph\footnote{TODO}
\end{itemize}

换句话说, 由 \texttt{gq} 与 \texttt{ap} 组合而成的命令告诉 Vim 去遍历当前段落
并格式化. 由两个空白行包围起来的部分定义为一个段落, 因此, 为了开始一个新的段
落, 只需要添加一个空行即可.

Vim 所做的格式化实际上是让行作出更漂亮的断行, 使得每一行的长度都不会超过某个
特定的大小 (Vim 自动地在适当的两个单词间作出断行).

格式化后文本的宽度由选项 \texttt{textwidth} 定义, 如果用户希望每行最大的宽度不
超过 80 个字符, 那就在 \texttt{vimrc} 中添加:
\begin{vimcode}
:set textwidth=80
\end{vimcode}
如果 \texttt{textwidth} 的值被设置为 0, 那么 Vim 就把它设置成窗口的宽度 ---
但是永远不会多于 \texttt{textwidth} 所设置的字符个数.
\marginpar{123}

\begin{warning}
    通过设置选项 \texttt{formatoptions} 可以控制 Vim 如何格式化段落. 更多的信
    息可以参考 \texttt{:help 'formatoptions'} 与 \texttt{:help 'fo-table'}.
\end{warning}

\texttt{gq} 可以和任意的移动命令配合使用, 并且在格式化之后, 光标将会停留在移动
命令结束的地方 (典型的情况是停留在当前特定区域的最后一行). 如果用户希望在格式
化后, 光标仍旧处于格式化开始前的位置, 那就把 \texttt{gq} 改成 \texttt{gw}. 如
果用户的光标原来是在段落中第一行的开始, 此时执行 \texttt{gwap}, 命令结束后, 光
标仍然会停留在段落中第一行的开始.

用户可以在命令的前面加上数字, 使得它重复执行, 例如, \texttt{5gqap} 将会对当前
与下面的四个段落进行格式化. 如果想要对文件内的所有段落进行格式化, 就执行
\texttt{1gqG}.

前面的介绍的格式化命令不仅对普通文本有效, 对其他任意类型的内容同样有效, 而且用
户可以决定使用哪种格式化函数.

用户可以为指定的文件类型设置任意的格式化函数, 方法是设置 Vim 的选项
\texttt{formatexpr}. 例如, 如果用户想要对 C 源代码进行格式化, 只需要在
\texttt{vimrc} 中添加:
\begin{vimcode}
:set formatexpr=c#Formatter()
\end{vimcode}
这行命令告诉 Vim, 在打开一个 C 源代码文件时, 使用函数 \texttt{Formatter()},
这个函数定义在 Vim 为 C 文件自动加载的文件中.

\begin{warning}
    自动回载的文件可以在 \texttt{VIMHOME} 的子目录 \texttt{autoload} 中找到.
    文件根据所服务的文件类型来命令, 以后缀 \texttt{.vim} 结束. 例如, 为 C 文
    件自动加载的文件是 \texttt{VIMHOME/autoload/c.vim}.
\end{warning}

一个格式化函数含有三个变量, 利用这三个变量可以找到待格式化的文本.
\begin{itemize}
    \item \texttt{v:num}: 待格式化的第一行的行号
    \item \texttt{v:count}: 待格式化的行的数量
    \item \texttt{v:char}: 这个变量包含了将被插入的字符, 可以为空
\end{itemize}

格式化函数的一个简单示例是:
\marginpar{124}
\begin{vimcode}
function! MyFormatter()
   let first = v:num
   let last = v:num + v:count
    while(first<=last)
       call setline(first, '> '. getline(first))
       let first = first+1
    endwhile
endfunction
\end{vimcode}
